---
import MainLayout from '@/layouts/MainLayout.astro';
import { getCurrentUser } from '@/lib/auth';
import { FormFeedback } from '@/components/FormFeedback';

const user = await getCurrentUser();
---

<MainLayout title="Nuova Notifica">
  <div class="p-8">
    <div class="max-w-3xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Nuova Notifica Push</h1>
      
      <form id="notificationForm" class="bg-white/80 backdrop-blur-md rounded-xl p-6 shadow-lg border border-white/20 space-y-6">
        <input type="hidden" id="currentUserId" value={user?.id} />
        
        <!-- Content Section -->
        <div class="border-b pb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Contenuto</h2>
          
          <div class="space-y-4">
            <div>
              <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                Titolo *
              </label>
              <input
                type="text"
                id="title"
                name="title"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              />
            </div>

            <div>
              <label for="body" class="block text-sm font-medium text-gray-700 mb-2">
                Messaggio *
              </label>
              <textarea
                id="body"
                name="body"
                rows="3"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              ></textarea>
            </div>

            <div>
              <label for="image" class="block text-sm font-medium text-gray-700 mb-2">
                Immagine URL (opzionale)
              </label>
              <input
                type="url"
                id="image"
                name="image"
                placeholder="https://..."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              />
            </div>
          </div>
        </div>

        <!-- Target Section -->
        <div class="border-b pb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Destinatari</h2>
          
          <div class="space-y-4">
            <div>
              <label for="target_type" class="block text-sm font-medium text-gray-700 mb-2">
                Tipo Target *
              </label>
              <select
                id="target_type"
                name="target_type"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              >
                <option value="all">Tutti gli utenti</option>
                <option value="segment">Segmento utenti</option>
                <option value="user">Utenti specifici</option>
              </select>
            </div>

            <div id="segmentField" style="display: none;">
              <label for="target_segment" class="block text-sm font-medium text-gray-700 mb-2">
                Segmento
              </label>
              <select
                id="target_segment"
                name="target_segment"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              >
                <option value="">Seleziona segmento...</option>
                <option value="tour_leaders">Tour Leaders</option>
                <option value="admins">Amministratori</option>
                <option value="active_users">Utenti Attivi</option>
              </select>
            </div>

            <div id="userIdsField" style="display: none;">
              <label for="target_user_ids" class="block text-sm font-medium text-gray-700 mb-2">
                User IDs (separati da virgola)
              </label>
              <textarea
                id="target_user_ids"
                name="target_user_ids"
                rows="2"
                placeholder="user_id_1, user_id_2, ..."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Action Section -->
        <div class="border-b pb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Azione (Deep Link)</h2>
          
          <div class="space-y-4">
            <div>
              <label for="action_type" class="block text-sm font-medium text-gray-700 mb-2">
                Tipo Azione
              </label>
              <select
                id="action_type"
                name="action_type"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              >
                <option value="none">Nessuna</option>
                <option value="article">Apri Articolo</option>
                <option value="author">Apri Autore</option>
                <option value="category">Apri Categoria</option>
                <option value="tag">Apri Tag</option>
                <option value="url">Apri URL Custom</option>
              </select>
            </div>

            <div id="actionIdField" style="display: none;">
              <label for="action_id" class="block text-sm font-medium text-gray-700 mb-2">
                ID Risorsa
              </label>
              <input
                type="text"
                id="action_id"
                name="action_id"
                placeholder="ID della risorsa (es. article_id)"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              />
            </div>

            <div id="actionUrlField" style="display: none;">
              <label for="action_url" class="block text-sm font-medium text-gray-700 mb-2">
                URL Custom
              </label>
              <input
                type="url"
                id="action_url"
                name="action_url"
                placeholder="https://..."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              />
            </div>
          </div>
        </div>

        <!-- Scheduling Section -->
        <div class="border-b pb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Programmazione</h2>
          
          <div class="space-y-4">
            <div>
              <label for="scheduled_at" class="block text-sm font-medium text-gray-700 mb-2">
                Data/Ora Invio (lascia vuoto per invio immediato)
              </label>
              <input
                type="datetime-local"
                id="scheduled_at"
                name="scheduled_at"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              />
            </div>

            <div>
              <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                Stato
              </label>
              <select
                id="status"
                name="status"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              >
                <option value="draft">Bozza</option>
                <option value="scheduled">Programmata</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3">
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-[#FF6B35] text-white rounded-lg hover:bg-[#ff8555] transition-colors"
          >
            Crea Notifica
          </button>
          <a
            href="/notifications"
            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
          >
            Annulla
          </a>
        </div>
      </form>
    </div>
  </div>

  <FormFeedback client:only="react" isLoading={false} success={null} error={null} />

  <script is:inline>
    const form = document.getElementById('notificationForm');
    const targetTypeSelect = document.getElementById('target_type');
    const actionTypeSelect = document.getElementById('action_type');
    let isLoading = false;
    
    function updateFeedback(props) {
      const event = new CustomEvent('formFeedback', { detail: props });
      window.dispatchEvent(event);
    }
    
    // Show/hide target fields based on type
    targetTypeSelect.addEventListener('change', () => {
      const value = targetTypeSelect.value;
      document.getElementById('segmentField').style.display = value === 'segment' ? 'block' : 'none';
      document.getElementById('userIdsField').style.display = value === 'user' ? 'block' : 'none';
    });
    
    // Show/hide action fields based on type
    actionTypeSelect.addEventListener('change', () => {
      const value = actionTypeSelect.value;
      const showId = ['article', 'author', 'category', 'tag'].includes(value);
      const showUrl = value === 'url';
      document.getElementById('actionIdField').style.display = showId ? 'block' : 'none';
      document.getElementById('actionUrlField').style.display = showUrl ? 'block' : 'none';
    });
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;
      isLoading = true;
      updateFeedback({ isLoading: true, success: null, error: null });
      
      const formData = new FormData(form);
      const userId = document.getElementById('currentUserId').value;
      
      const data = {
        title: formData.get('title'),
        body: formData.get('body'),
        target_type: formData.get('target_type'),
        status: formData.get('status'),
        author_id: userId,
      };
      
      // Optional fields
      if (formData.get('image')) data.image = formData.get('image');
      if (formData.get('target_segment')) data.target_segment = formData.get('target_segment');
      if (formData.get('target_user_ids')) {
        data.target_user_ids = formData.get('target_user_ids').split(',').map(id => id.trim());
      }
      if (formData.get('action_type')) data.action_type = formData.get('action_type');
      if (formData.get('action_id')) data.action_id = formData.get('action_id');
      if (formData.get('action_url')) data.action_url = formData.get('action_url');
      if (formData.get('scheduled_at')) {
        data.scheduled_at = new Date(formData.get('scheduled_at')).toISOString();
      }
      
      try {
        const response = await fetch('/api/notifications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        
        isLoading = false;
        
        if (response.ok) {
          const result = await response.json();
          updateFeedback({ 
            isLoading: false, 
            success: { 
              show: true, 
              message: 'Notifica creata con successo!'
            }, 
            error: null 
          });
          setTimeout(() => {
            window.location.href = `/notifications/edit/${result.id}`;
          }, 1000);
        } else {
          const error = await response.json();
          updateFeedback({ 
            isLoading: false, 
            success: null, 
            error: { 
              show: true, 
              message: error.message || 'Errore durante la creazione'
            }
          });
        }
      } catch (error) {
        console.error(error);
        isLoading = false;
        updateFeedback({ 
          isLoading: false, 
          success: null, 
          error: { 
            show: true, 
            message: 'Errore durante la creazione della notifica'
          }
        });
      }
    });
  </script>
</MainLayout>
