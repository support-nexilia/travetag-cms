---
import MainLayout from '@/layouts/MainLayout.astro';
import { getAllAuthors, getTourLeaders } from '@/data/author';
import { ArticleForm } from '@/components/form/ArticleForm';

const authors = await getAllAuthors();
const tourLeaders = await getTourLeaders();
---

<MainLayout title="Nuovo Articolo">
  <div class="p-8">
    <div class="max-w-5xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Nuovo Articolo</h1>
      
      <ArticleForm 
        mode="new"
        authors={authors}
        tourLeaders={tourLeaders}
        client:load
      />
    </div>
  </div>
</MainLayout>

<script>
  // Handle form submission
  document.addEventListener('submit', async (e) => {
    const form = e.target as HTMLFormElement;
    if (form.id === 'articleForm') {
      e.preventDefault();
      
      const formData = new FormData(form);
      const data: any = {};
      
      // Process form data
      formData.forEach((value, key) => {
        if (key.includes('[')) {
          // Handle array fields like tag_ids[0], category_ids[1]
          const match = key.match(/^(.+)\[(\d+)\]$/);
          if (match) {
            const fieldName = match[1];
            if (!data[fieldName]) data[fieldName] = [];
            data[fieldName].push(value);
          }
        } else {
          data[key] = value;
        }
      });
      
      try {
        const response = await fetch('/api/articles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        
        if (response.ok) {
          window.location.href = '/articles';
        } else {
          const error = await response.json();
          alert('Errore: ' + (error.message || 'Impossibile creare l\'articolo'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Errore di rete');
      }
    }
  });
</script>
