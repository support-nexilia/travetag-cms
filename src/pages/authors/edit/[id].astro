---
import MainLayout from '@/layouts/MainLayout.astro';
import { getAuthorById } from '@/data/author';

const { id } = Astro.params;
if (!id) return Astro.redirect('/authors');

const author = await getAuthorById(id);
if (!author) return Astro.redirect('/authors');
---

<MainLayout title={`Modifica ${author.name}`}>
  <div class="p-8">
    <div class="max-w-3xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Modifica Autore</h1>
      
      <form id="authorForm" class="bg-white/80 backdrop-blur-md rounded-xl p-6 shadow-lg border border-white/20 space-y-6">
        <input type="hidden" id="authorId" value={author._id.toString()} />
        
        <!-- Info Base -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              Nome Completo *
            </label>
            <input
              type="text"
              id="name"
              name="name"
              value={author.name}
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
            />
          </div>

          <div>
            <label for="nickname" class="block text-sm font-medium text-gray-700 mb-2">
              Nickname
            </label>
            <input
              type="text"
              id="nickname"
              name="nickname"
              value={author.nickname || ''}
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
            />
          </div>
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
            Email *
          </label>
          <input
            type="email"
            id="email"
            name="email"
            value={author.email}
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
          />
        </div>

        <div>
          <label for="bio" class="block text-sm font-medium text-gray-700 mb-2">
            Biografia
          </label>
          <textarea
            id="bio"
            name="bio"
            rows="4"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
          >{author.bio || ''}</textarea>
        </div>

        <!-- Immagini -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="image" class="block text-sm font-medium text-gray-700 mb-2">
              URL Immagine Profilo
            </label>
            <input
              type="url"
              id="image"
              name="image"
              value={author.image || ''}
              placeholder="https://..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
            />
            {author.image && (
              <img src={author.image} alt="Preview" class="mt-2 w-20 h-20 rounded-full object-cover" />
            )}
          </div>

          <div>
            <label for="background_image" class="block text-sm font-medium text-gray-700 mb-2">
              URL Immagine Sfondo
            </label>
            <input
              type="url"
              id="background_image"
              name="background_image"
              value={author.background_image || ''}
              placeholder="https://..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
            />
          </div>
        </div>

        <!-- Ruoli -->
        <div class="border-t pt-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Ruoli</h3>
          <div class="space-y-2">
            <label class="flex items-center gap-2">
              <input
                type="checkbox"
                id="is_admin"
                name="is_admin"
                checked={author.is_admin}
                class="w-4 h-4 text-[#FF6B35] border-gray-300 rounded focus:ring-[#FF6B35]"
              />
              <span class="text-sm text-gray-700">Amministratore</span>
            </label>

            <label class="flex items-center gap-2">
              <input
                type="checkbox"
                id="is_tour_leader"
                name="is_tour_leader"
                checked={author.is_tour_leader || false}
                class="w-4 h-4 text-[#FF6B35] border-gray-300 rounded focus:ring-[#FF6B35]"
              />
              <span class="text-sm text-gray-700">Tour Leader</span>
            </label>
          </div>
        </div>

        <!-- Lingue -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Lingue Parlate
          </label>
          <div class="grid grid-cols-5 gap-2">
            {['it', 'en', 'es', 'fr', 'de'].map((lang) => (
              <label class="flex items-center gap-2">
                <input
                  type="checkbox"
                  name="languages"
                  value={lang}
                  checked={author.languages.includes(lang)}
                  class="w-4 h-4 text-[#FF6B35] border-gray-300 rounded focus:ring-[#FF6B35]"
                />
                <span class="text-sm text-gray-700 uppercase">{lang}</span>
              </label>
            ))}
          </div>
        </div>

        <!-- Social Networks -->
        <div class="border-t pt-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Social Networks</h3>
          <div id="socialContainer" class="space-y-3">
            <!-- Social items will be added here dynamically -->
          </div>
          <button
            type="button"
            id="addSocial"
            class="mt-2 px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
          >
            + Aggiungi Social
          </button>
        </div>

        <div class="flex gap-3 pt-4 border-t">
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-[#FF6B35] text-white rounded-lg hover:bg-[#ff8555] transition-colors"
          >
            Salva Modifiche
          </button>
          <a
            href="/authors"
            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
          >
            Annulla
          </a>
        </div>
      </form>
    </div>
  </div>

  <script define:vars={{ authorSocial: author.social }}>
    const socialTypes = ['instagram', 'facebook', 'twitter', 'linkedin', 'tiktok'] as const;
    let socialCount = 0;

    const socialContainer = document.getElementById('socialContainer')!;
    const addSocialBtn = document.getElementById('addSocial')!;

    function addSocialField(type = '', url = '') {
      const div = document.createElement('div');
      div.className = 'flex gap-2';
      div.innerHTML = `
        <select 
          name="social_type_${socialCount}" 
          class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
        >
          ${socialTypes.map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('')}
        </select>
        <input
          type="url"
          name="social_url_${socialCount}"
          value="${url}"
          placeholder="https://..."
          class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
        />
        <button
          type="button"
          class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors remove-social"
        >
          Ã—
        </button>
      `;
      
      div.querySelector('.remove-social')?.addEventListener('click', () => {
        div.remove();
      });
      
      socialContainer.appendChild(div);
      socialCount++;
    }

    // Load existing social networks
    if (authorSocial && authorSocial.length > 0) {
      authorSocial.forEach((social: any) => {
        addSocialField(social.type, social.url);
      });
    }

    addSocialBtn.addEventListener('click', () => addSocialField());

    const form = document.getElementById('authorForm') as HTMLFormElement;
    const authorId = (document.getElementById('authorId') as HTMLInputElement).value;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      
      // Collect languages
      const languages: string[] = [];
      formData.getAll('languages').forEach((lang) => languages.push(lang as string));
      
      // Collect social networks
      const social: Array<{ type: string; url: string }> = [];
      for (let i = 0; i < socialCount; i++) {
        const type = formData.get(`social_type_${i}`) as string;
        const url = formData.get(`social_url_${i}`) as string;
        if (type && url) {
          social.push({ type, url });
        }
      }
      
      const data = {
        name: formData.get('name') as string,
        nickname: (formData.get('nickname') as string) || undefined,
        email: formData.get('email') as string,
        bio: (formData.get('bio') as string) || undefined,
        image: (formData.get('image') as string) || undefined,
        background_image: (formData.get('background_image') as string) || undefined,
        is_admin: formData.get('is_admin') === 'on',
        is_tour_leader: formData.get('is_tour_leader') === 'on' || undefined,
        languages,
        social,
      };
      
      try {
        const response = await fetch(`/api/authors/${authorId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        
        if (response.ok) {
          window.location.href = '/authors';
        } else {
          const error = await response.json();
          alert('Errore: ' + (error.message || 'Impossibile aggiornare l\'autore'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Errore durante l\'aggiornamento dell\'autore');
      }
    });
  </script>
</MainLayout>
