---
import MainLayout from '@/layouts/MainLayout.astro';
import { getAllNotifications } from '@/data/notification';
import { StatusBadge } from '@/components/StatusBadge';

const notifications = await getAllNotifications(undefined, true);
---

<MainLayout title="Notifiche">
  <div class="p-8">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Notifiche Push</h1>
        <a
          href="/admin/notifications/new"
          class="px-4 py-2 bg-[#FF6B35] text-white rounded-lg hover:bg-[#ff8555] transition-colors"
        >
          + Nuova Notifica
        </a>
      </div>

      <div class="bg-white/80 backdrop-blur-md rounded-xl shadow-lg border border-white/20 overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Titolo</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Target</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Programmata</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stato</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statistiche</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Azioni</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {notifications.map((notification) => (
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span class="font-medium text-gray-900">{notification.title}</span>
                    <span class="text-sm text-gray-500 truncate max-w-md">{notification.body}</span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    {notification.target_type === 'all' ? 'Tutti' : 
                     notification.target_type === 'user' ? 'Utenti specifici' : 
                     notification.target_segment || 'Segmento'}
                  </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  {notification.scheduled_at 
                    ? new Date(notification.scheduled_at).toLocaleString('it-IT')
                    : 'Immediato'}
                </td>
                <td class="px-6 py-4">
                  <StatusBadge 
                    client:load
                    status={notification.status} 
                    labels={{
                      draft: 'Bozza',
                      scheduled: 'Programmata',
                      sent: 'Inviata',
                      failed: 'Fallita'
                    }}
                  />
                </td>
                <td class="px-6 py-4 text-sm">
                  {notification.status === 'sent' && (
                    <div class="text-gray-600">
                      <div>✓ {notification.sent_count}</div>
                      {notification.failed_count > 0 && (
                        <div class="text-red-600">✗ {notification.failed_count}</div>
                      )}
                    </div>
                  )}
                </td>
                <td class="px-6 py-4 text-sm">
                  <div class="flex gap-2">
                    <a
                      href={`/notifications/edit/${notification._id}`}
                      class="text-[#FF6B35] hover:text-[#ff8555] font-medium"
                    >
                      Modifica
                    </a>
                    {notification.status !== 'sent' && (
                      <button
                        class="text-red-600 hover:text-red-800 font-medium delete-btn"
                        data-id={notification._id}
                      >
                        Elimina
                      </button>
                    )}
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {notifications.length === 0 && (
          <div class="text-center py-12 text-gray-500">
            Nessuna notifica trovata. Creane una nuova!
          </div>
        )}
      </div>
    </div>
  </div>

  <script is:inline>
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (!confirm('Sei sicuro di voler eliminare questa notifica?')) return;
        
        try {
          const response = await fetch(`/admin/api/notifications/${id}`, {
            method: 'DELETE',
          });
          
          if (response.ok) {
            window.location.reload();
          } else {
            const error = await response.json();
            alert('Errore: ' + (error.message || 'Impossibile eliminare'));
          }
        } catch (error) {
          console.error(error);
          alert('Errore durante l\'eliminazione');
        }
      });
    });
  </script>
</MainLayout>
