---
import MainLayout from '@/layouts/MainLayout.astro';
import { getAllAuthors, getTourLeaders } from '@/data/author';
import { ArticleForm } from '@/components/form/ArticleForm';
import FormFeedback from '@/components/FormFeedback';

const authors = await getAllAuthors();
const tourLeaders = await getTourLeaders();
---

<MainLayout title="Nuovo Articolo">
  <FormFeedback client:load isLoading={false} success={null} error={null} />
  <div class="p-8">
    <div class="max-w-5xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Nuovo Articolo</h1>
      
      <ArticleForm 
        mode="new"
        authors={authors}
        tourLeaders={tourLeaders}
        client:load
      />
    </div>
  </div>
</MainLayout>

<script>
  let isLoading = false;

  function updateFeedback(props: { isLoading: boolean; success: { show: boolean; message: string } | null; error: { show: boolean; message: string } | null }) {
    const event = new CustomEvent('formFeedback', { detail: props });
    window.dispatchEvent(event);
  }

  // Handle form submission
  document.addEventListener('submit', async (e) => {
    const form = e.target as HTMLFormElement;
    if (form.id === 'articleForm') {
      e.preventDefault();
      
      if (isLoading) return;
      isLoading = true;
      updateFeedback({ isLoading: true, success: null, error: null });
      
      const formData = new FormData(form);
      const data: any = {};
      
      const fileFields = new Set([
        'image_file',
        'image_hero_file',
        'video_full_file',
        'itinerary_image_file',
      ]);
      const mediaUploads = [];

      // Process form data
      formData.forEach((value, key) => {
        if (fileFields.has(key)) {
          if (value instanceof File && value.size > 0) {
            mediaUploads.push({ key, file: value });
          }
          return;
        }
        // Handle nested array fields like itinerary_items[0][title]
        const nestedMatch = key.match(/^(.+)\[(\d+)\]\[(.+)\]$/);
        if (nestedMatch) {
          const fieldName = nestedMatch[1];
          const index = parseInt(nestedMatch[2]);
          const subField = nestedMatch[3];
          
          if (!data[fieldName]) data[fieldName] = [];
          if (!data[fieldName][index]) data[fieldName][index] = {};
          data[fieldName][index][subField] = value;
        }
        // Handle simple array fields like tag_ids[0]
        else if (key.includes('[')) {
          const match = key.match(/^(.+)\[(\d+)\]$/);
          if (match) {
            const fieldName = match[1];
            if (!data[fieldName]) data[fieldName] = [];
            data[fieldName].push(value);
          }
        } else {
          data[key] = value;
        }
      });
      
      const uploadMedia = async (entityId, upload) => {
        const mediaType = upload.key === 'video_full_file' ? 'video' : 'image';
        const fieldMap = {
          image_file: 'image',
          image_hero_file: 'image_hero',
          video_full_file: 'video_full',
          itinerary_image_file: 'itinerary_image',
        };
        const field = fieldMap[upload.key];

        if (!field) return null;

        const presignResponse = await fetch('/admin/api/media/presign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: upload.file.name,
            contentType: upload.file.type,
          }),
        });

        if (!presignResponse.ok) {
          throw new Error('Impossibile generare la presigned URL');
        }

        const presign = await presignResponse.json();

        const uploadResponse = await fetch(presign.uploadUrl, {
          method: 'PUT',
          headers: presign.headers,
          body: upload.file,
        });

        if (!uploadResponse.ok) {
          throw new Error('Upload media fallito');
        }

        const finalizeResponse = await fetch('/admin/api/media/finalize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mediaType,
            tmpKey: presign.key,
            entity: 'article',
            entityId,
            field,
            filename: upload.file.name,
            contentType: upload.file.type,
          }),
        });

        if (!finalizeResponse.ok) {
          throw new Error('Finalize media fallito');
        }

        const finalize = await finalizeResponse.json();
        return { field, media: finalize.media };
      };

      try {
        const response = await fetch('/admin/api/articles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        
        if (response.ok) {
          const result = await response.json();
          const entityId = result._id || result.id;
          if (entityId && mediaUploads.length > 0) {
            const mediaUpdates = {};
            for (const upload of mediaUploads) {
              const result = await uploadMedia(entityId, upload);
              if (result) {
                mediaUpdates[result.field] = result.media;
              }
            }
            if (Object.keys(mediaUpdates).length > 0) {
              await fetch(`/admin/api/articles/${entityId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(mediaUpdates),
              });
            }
          }
          updateFeedback({ 
            isLoading: false, 
            success: { show: true, message: 'Articolo creato con successo!' }, 
            error: null 
          });
          setTimeout(() => {
            window.location.href = `/articles/edit/${entityId || result.id}`;
          }, 1000);
        } else {
          const error = await response.json();
          isLoading = false;
          updateFeedback({ 
            isLoading: false, 
            success: null, 
            error: { show: true, message: error.message || 'Impossibile creare l\'articolo' } 
          });
        }
      } catch (error) {
        console.error('Error:', error);
        isLoading = false;
        updateFeedback({ 
          isLoading: false, 
          success: null, 
          error: { show: true, message: 'Errore durante la creazione dell\'articolo' } 
        });
      }
    }
  });
</script>
