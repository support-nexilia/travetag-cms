---
import MainLayout from '@/layouts/MainLayout.astro';
import { getAllAuthors, getTourLeaders } from '@/data/author';
import { ArticleForm } from '@/components/form/ArticleForm';
import FormFeedback from '@/components/FormFeedback';

const authors = await getAllAuthors();
const tourLeaders = await getTourLeaders();
---

<MainLayout title="Nuovo Articolo">
  <FormFeedback client:load isLoading={false} success={null} error={null} />
  <div class="p-8">
    <div class="max-w-5xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Nuovo Articolo</h1>
      
      <ArticleForm 
        mode="new"
        authors={authors}
        tourLeaders={tourLeaders}
        client:only="react"
      />
    </div>
  </div>
</MainLayout>

<script>
  let isLoading = false;

  function updateFeedback(props: { isLoading: boolean; success: { show: boolean; message: string } | null; error: { show: boolean; message: string } | null }) {
    const event = new CustomEvent('formFeedback', { detail: props });
    window.dispatchEvent(event);
  }

  // Handle form submission
  document.addEventListener('submit', async (e) => {
    const form = e.target as HTMLFormElement;
    if (form.id === 'articleForm') {
      e.preventDefault();
      
      if (isLoading) return;
      isLoading = true;
      updateFeedback({ isLoading: true, success: null, error: null });
      
      const formData = new FormData(form);
      const data: any = {};
      
      // Process form data
      formData.forEach((value, key) => {
        if (key.endsWith('_remove')) return;
        if (key.endsWith('_media_id') && typeof value === 'string' && !value) return;
        // Handle nested array fields like itinerary_items[0][title]
        const nestedMatch = key.match(/^(.+)\[(\d+)\]\[(.+)\]$/);
        if (nestedMatch) {
          const fieldName = nestedMatch[1];
          const index = parseInt(nestedMatch[2]);
          const subField = nestedMatch[3];
          
          if (!data[fieldName]) data[fieldName] = [];
          if (!data[fieldName][index]) data[fieldName][index] = {};
          data[fieldName][index][subField] = value;
        }
        // Handle simple array fields like tag_ids[0]
        else if (key.includes('[')) {
          const match = key.match(/^(.+)\[(\d+)\]$/);
          if (match) {
            const fieldName = match[1];
            if (!data[fieldName]) data[fieldName] = [];
            data[fieldName].push(value);
          }
        } else {
          data[key] = value;
        }
      });

      const mediaFields = [
        'image_media_id',
        'image_hero_media_id',
        'video_full_media_id',
        'itinerary_image_media_id',
      ];

      mediaFields.forEach((field) => {
        const remove = formData.get(`${field}_remove`) === 'true';
        const value = formData.get(field);
        if (remove) {
          data[field] = null;
        } else if (value) {
          data[field] = value;
        }
      });
      
      try {
        const response = await fetch('/admin/api/articles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        
        if (response.ok) {
          const result = await response.json();
          const entityId = result._id || result.id;
          updateFeedback({ 
            isLoading: false, 
            success: { show: true, message: 'Articolo creato con successo!' }, 
            error: null 
          });
          setTimeout(() => {
            window.location.href = `/articles/edit/${entityId || result.id}`;
          }, 1000);
        } else {
          const error = await response.json();
          isLoading = false;
          updateFeedback({ 
            isLoading: false, 
            success: null, 
            error: { show: true, message: error.message || 'Impossibile creare l\'articolo' } 
          });
        }
      } catch (error) {
        console.error('Error:', error);
        isLoading = false;
        updateFeedback({ 
          isLoading: false, 
          success: null, 
          error: { show: true, message: 'Errore durante la creazione dell\'articolo' } 
        });
      }
    }
  });
</script>
