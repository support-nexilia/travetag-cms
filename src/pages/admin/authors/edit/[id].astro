---
import MainLayout from '@/layouts/MainLayout.astro';
import { getAuthorById } from '@/data/author';
import { FormFeedback } from '@/components/FormFeedback';
import { MediaPickerField } from '@/components/form/MediaPickerField';

const { id } = Astro.params;
if (!id) return Astro.redirect('/admin/authors');

const author = await getAuthorById(id);
if (!author) return Astro.redirect('/admin/authors');

const imageMediaId = author.image_media_id ? author.image_media_id.toString() : '';
const backgroundImageMediaId = author.background_image_media_id
  ? author.background_image_media_id.toString()
  : '';
---

<MainLayout title={`Modifica ${author.name}`}>
  <div class="p-8">
    <div class="max-w-3xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Modifica Autore</h1>
      
      <form id="authorForm" class="bg-white/80 backdrop-blur-md rounded-xl p-6 shadow-lg border border-white/20 space-y-6">
        <input type="hidden" id="authorId" value={author._id.toString()} />
        
        <!-- Info Base -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              Nome Completo *
            </label>
            <input
              type="text"
              id="name"
              name="name"
              value={author.name}
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
            />
          </div>

          <div>
            <label for="nickname" class="block text-sm font-medium text-gray-700 mb-2">
              Nickname
            </label>
            <input
              type="text"
              id="nickname"
              name="nickname"
              value={author.nickname || ''}
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
            />
          </div>
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
            Email *
          </label>
          <input
            type="email"
            id="email"
            name="email"
            value={author.email}
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
          />
        </div>

        <div>
          <label for="bio" class="block text-sm font-medium text-gray-700 mb-2">
            Biografia
          </label>
          <textarea
            id="bio"
            name="bio"
            rows="4"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
          >{author.bio || ''}</textarea>
        </div>

        <!-- Immagini -->
        <div class="grid grid-cols-2 gap-4">
          <MediaPickerField
            client:load
            name="image_media_id"
            label="Immagine Profilo"
            mediaType="image"
            initialMediaId={imageMediaId}
          />

          <MediaPickerField
            client:load
            name="background_image_media_id"
            label="Immagine Sfondo"
            mediaType="image"
            initialMediaId={backgroundImageMediaId}
          />
        </div>

        <!-- Ruolo e Namespace -->
        <div class="border-t pt-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Ruolo e Permessi</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="role" class="block text-sm font-medium text-gray-700 mb-2">
                Ruolo *
              </label>
              <select
                id="role"
                name="role"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              >
                <option value="">Seleziona ruolo</option>
                <option value="admin" selected={author.role === 'admin' || author.is_admin}>Admin</option>
                <option value="editor" selected={author.role === 'editor'}>Editor</option>
                <option value="tourleader" selected={author.role === 'tourleader' || author.is_tour_leader}>Tour Leader</option>
              </select>
            </div>

            <div>
              <label for="namespace" class="block text-sm font-medium text-gray-700 mb-2">
                Namespace
                <span class="text-xs text-gray-500">(opzionale per admin)</span>
              </label>
              <input
                type="text"
                id="namespace"
                name="namespace"
                value={author.namespace || ''}
                placeholder="es: italia"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
              />
            </div>
          </div>
        </div>

        <!-- Lingue -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Lingue Parlate
          </label>
          <div class="grid grid-cols-5 gap-2">
            {['it', 'en', 'es', 'fr', 'de'].map((lang) => (
              <label class="flex items-center gap-2">
                <input
                  type="checkbox"
                  name="languages"
                  value={lang}
                  checked={author.languages.includes(lang)}
                  class="w-4 h-4 text-[#FF6B35] border-gray-300 rounded focus:ring-[#FF6B35]"
                />
                <span class="text-sm text-gray-700 uppercase">{lang}</span>
              </label>
            ))}
          </div>
        </div>

        <!-- Social Networks -->
        <div class="border-t pt-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Social Networks</h3>
          <div id="socialContainer" class="space-y-3">
            <!-- Social items will be added here dynamically -->
          </div>
          <button
            type="button"
            id="addSocial"
            class="mt-2 px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
          >
            + Aggiungi Social
          </button>
        </div>

        <div class="flex gap-3 pt-4 border-t">
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-[#FF6B35] text-white rounded-lg hover:bg-[#ff8555] transition-colors"
          >
            Salva Modifiche
          </button>
          <a
            href="/admin/authors"
            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
          >
            Annulla
          </a>
        </div>
      </form>
    </div>
  </div>

  <FormFeedback client:only="react" isLoading={false} success={null} error={null} />

  <script is:inline define:vars={{ authorSocial: author.social }}>
    const socialTypes = ['instagram', 'facebook', 'twitter', 'linkedin', 'tiktok'];
    let socialCount = 0;

    const socialContainer = document.getElementById('socialContainer');
    const addSocialBtn = document.getElementById('addSocial');

    function addSocialField(type = '', url = '') {
      const div = document.createElement('div');
      div.className = 'flex gap-2';
      div.innerHTML = `
        <select 
          name="social_type_${socialCount}" 
          class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
        >
          ${socialTypes.map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('')}
        </select>
        <input
          type="url"
          name="social_url_${socialCount}"
          value="${url}"
          placeholder="https://..."
          class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]"
        />
        <button
          type="button"
          class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors remove-social"
        >
          Ã—
        </button>
      `;
      
      div.querySelector('.remove-social')?.addEventListener('click', () => {
        div.remove();
      });
      
      socialContainer.appendChild(div);
      socialCount++;
    }

    // Load existing social networks
    if (authorSocial && authorSocial.length > 0) {
      authorSocial.forEach((social) => {
        addSocialField(social.type, social.url);
      });
    }

    addSocialBtn.addEventListener('click', () => addSocialField());

    const form = document.getElementById('authorForm');
    const authorId = document.getElementById('authorId').value;
    let isLoading = false;
    
    function updateFeedback(props) {
      const event = new CustomEvent('formFeedback', { detail: props });
      window.dispatchEvent(event);
    }
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;
      isLoading = true;
      updateFeedback({ isLoading: true, success: null, error: null });
      
      const formData = new FormData(form);
      
      // Collect languages
      const languages = [];
      formData.getAll('languages').forEach((lang) => languages.push(lang));
      
      // Collect social networks
      const social = [];
      for (let i = 0; i < socialCount; i++) {
        const type = formData.get(`social_type_${i}`);
        const url = formData.get(`social_url_${i}`);
        if (type && url) {
          social.push({ type, url });
        }
      }
      
      const data: any = {
        name: formData.get('name'),
        nickname: formData.get('nickname') || undefined,
        email: formData.get('email'),
        bio: formData.get('bio') || undefined,
        
        role: formData.get('role'),
        namespace: formData.get('namespace') || undefined,
        languages,
        social,
      };
      const imageMediaIdValue = formData.get('image_media_id');
      const imageMediaRemove = formData.get('image_media_id_remove') === 'true';
      const backgroundMediaIdValue = formData.get('background_image_media_id');
      const backgroundMediaRemove = formData.get('background_image_media_id_remove') === 'true';

      if (imageMediaRemove) {
        data.image_media_id = null;
      } else if (imageMediaIdValue) {
        data.image_media_id = imageMediaIdValue;
      }

      if (backgroundMediaRemove) {
        data.background_image_media_id = null;
      } else if (backgroundMediaIdValue) {
        data.background_image_media_id = backgroundMediaIdValue;
      }

      try {
        const response = await fetch(`/admin/api/authors/${authorId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        
        isLoading = false;
        
        if (response.ok) {
          updateFeedback({ 
            isLoading: false, 
            success: { 
              show: true, 
              message: 'Autore aggiornato con successo!'
            }, 
            error: null 
          });
        } else {
          const error = await response.json();
          updateFeedback({ 
            isLoading: false, 
            success: null, 
            error: { 
              show: true, 
              message: error.message || 'Impossibile aggiornare l\'autore'
            }
          });
        }
      } catch (error) {
        console.error('Error:', error);
        isLoading = false;
        updateFeedback({ 
          isLoading: false, 
          success: null, 
          error: { 
            show: true, 
            message: 'Errore durante l\'aggiornamento dell\'autore'
          }
        });
      }
    });
  </script>
</MainLayout>
